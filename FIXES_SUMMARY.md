# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º OvozPay Bot

## –î–∞—Ç–∞: 2024
## –í–µ—Ä—Å–∏—è: 2.0 (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)

---

## üîß –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### 1. **–ü—Ä–æ–±–ª–µ–º—ã —Å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ–º —Ç–µ–∫—Å—Ç–∞**

#### ‚ùå –ß—Ç–æ –±—ã–ª–æ —Å–ª–æ–º–∞–Ω–æ:
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—É–º–º —Å –∑–∞–ø—è—Ç—ã–º–∏ (1,500 ‚Üí 500)
- –ü—Ä–æ–±–ª–µ–º—ã —Å —á–∏—Å–ª–∞–º–∏ –±–µ–∑ –≤–∞–ª—é—Ç–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤
- –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–±–µ–ª–æ–≤ –≤ —á–∏—Å–ª–∞—Ö
- –°–ª–∏—à–∫–æ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –æ–ø–∏—Å–∞–Ω–∏–π

#### ‚úÖ –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:

**–£–ª—É—á—à–µ–Ω–Ω—ã–µ –≤–∞–ª—é—Ç–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã:**
```python
# –ë—ã–ª–æ:
r'(\d+(?:\s*\d+)*(?:[,.]\d{1,2})?)\s*–¥–æ–ª–ª–∞—Ä'

# –°—Ç–∞–ª–æ:
r'(\d+(?:[,\s]\d{3})*(?:[,.]\d{1,2})?)\s*–¥–æ–ª–ª–∞—Ä'
```

**–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—è—Ç—ã—Ö:**
```python
# –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–ø—è—Ç—ã–µ: –µ—Å–ª–∏ —ç—Ç–æ —Ç—ã—Å—è—á–∏ (1,500) –∏–ª–∏ –¥–µ—Å—è—Ç–∏—á–Ω—ã–µ (1,50)
if ',' in amount_str:
    parts = amount_str.split(',')
    if len(parts) == 2:
        # –ï—Å–ª–∏ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π 3 —Ü–∏—Ñ—Ä—ã - —ç—Ç–æ —Ç—ã—Å—è—á–∏
        if len(parts[1]) == 3 and parts[1].isdigit():
            amount_str = parts[0] + parts[1]  # 1,500 ‚Üí 1500
        # –ï—Å–ª–∏ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π 1-2 —Ü–∏—Ñ—Ä—ã - —ç—Ç–æ –¥–µ—Å—è—Ç–∏—á–Ω—ã–µ
        elif len(parts[1]) <= 2 and parts[1].isdigit():
            amount_str = parts[0] + '.' + parts[1]  # 1,50 ‚Üí 1.50
```

**–£–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ–ø–∏—Å–∞–Ω–∏–π:**
- –ú–µ–Ω–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞
- Fallback –∞–ª–≥–æ—Ä–∏—Ç–º –¥–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö –æ–ø–∏—Å–∞–Ω–∏–π
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–Ω–∞—á–∏–º—ã—Ö —Å–ª–æ–≤

#### üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
- **–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:** ~60% —Ç–æ—á–Ω–æ—Å—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
- **–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:** **82.6% —Ç–æ—á–Ω–æ—Å—Ç—å** (19/23 —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ)

---

### 2. **–ü–µ—Ä–µ—Ö–æ–¥ —Å InlineKeyboard –Ω–∞ ReplyKeyboard**

#### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞:
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∂–∞–ª–æ–≤–∞–ª–∏—Å—å –Ω–∞ –Ω–µ—É–¥–æ–±—Å—Ç–≤–æ inline-–∫–Ω–æ–ø–æ–∫:
- –ü—É—Å—Ç–æ–µ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –±–µ–∑ –ø–æ–¥—Å–∫–∞–∑–æ–∫
- –ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞—Ç—å —á–∞—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–Ω–æ–ø–æ–∫
- –ù–µ–∏–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

#### ‚úÖ –†–µ—à–µ–Ω–∏–µ:

**–ü–æ–ª–Ω–∞—è –∑–∞–º–µ–Ω–∞ —Ç–∏–ø–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä:**

**–ë—ã–ª–æ (InlineKeyboard):**
```python
{
    'inline_keyboard': [
        [
            {'text': 'üá∑üá∫ –†—É—Å—Å–∫–∏–π', 'callback_data': 'lang_ru'},
            {'text': 'üá∫üá∏ English', 'callback_data': 'lang_en'}
        ]
    ]
}
```

**–°—Ç–∞–ª–æ (ReplyKeyboard):**
```python
{
    'keyboard': [
        ['üá∑üá∫ –†—É—Å—Å–∫–∏–π', 'üá∫üá∏ English'],
        ['üá∫üáø O\'zbekcha']
    ],
    'resize_keyboard': True,
    'one_time_keyboard': True  # –î–ª—è –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞/–≤–∞–ª—é—Ç—ã
}
```

**–û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π:**
```python
# –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ —è–∑—ã–∫–∞
if text in ['üá∑üá∫ –†—É—Å—Å–∫–∏–π', 'üá∫üá∏ English', 'üá∫üáø O\'zbekcha']:
    await self._handle_language_button(chat_id, text, user)
    return

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ –≤–∞–ª—é—Ç
if any(currency in text for currency in ['üíµ', 'üí∂', 'üí¥', 'üí∑']):
    await self._handle_currency_button(chat_id, text, user)
    return

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
menu_buttons = {
    t.get_text('menu_balance', language): 'show_balance',
    t.get_text('menu_history', language): 'show_history',
    # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
}
```

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

### –¢–µ—Å—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞:

```bash
python test_enhanced_parser_fix.py
```

**–£—Å–ø–µ—à–Ω—ã–µ —Å–ª—É—á–∞–∏:**
- ‚úÖ "–ø–æ—Ç—Ä–∞—Ç–∏–ª 10000 —Å—É–º –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç—ã" ‚Üí –µ–¥–∞, 10000 UZS
- ‚úÖ "–∫—É–ø–∏–ª –∑–∞ 1,500 –¥–æ–ª–ª–∞—Ä–æ–≤" ‚Üí 1500 USD (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ!)
- ‚úÖ "–ø–æ—Ç—Ä–∞—Ç–∏–ª 2.5 –¥–æ–ª–ª–∞—Ä–∞ –Ω–∞ –∫–æ—Ñ–µ" ‚Üí –µ–¥–∞, 2.5 USD
- ‚úÖ "—Å–æ–∑–¥–∞–π –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç" ‚Üí –∫–æ–º–∞–Ω–¥–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- ‚úÖ "—É–¥–∞–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –µ–¥–∞" ‚Üí –∫–æ–º–∞–Ω–¥–∞ —É–¥–∞–ª–µ–Ω–∏—è

**–ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- ‚ùå –ß–∏—Å–ª–∞ —Å–ª–æ–≤–∞–º–∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è ("–ø—è—Ç—å—Å–æ—Ç —Ä—É–±–ª–µ–π")
- ‚ùå –ù—É–ª–µ–≤—ã–µ —Å—É–º–º—ã –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è (–∑–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫)
- ‚ùå –ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–µ —Å—É–º–º—ã –±–µ–∑ —á–∏—Å–µ–ª –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è

---

## üìÅ –ò–ó–ú–ï–ù–ï–ù–ù–´–ï –§–ê–ô–õ–´

### 1. `backend/apps/bot/services/text_parser_service.py`
**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≤–∞–ª—é—Ç–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
- –£–ª—É—á—à–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—è—Ç—ã—Ö
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –æ—á–∏—Å—Ç–∫–∞ –æ–ø–∏—Å–∞–Ω–∏–π

### 2. `backend/apps/bot/utils/translations.py`
**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –í—Å–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –ø–µ—Ä–µ–≤–µ–¥–µ–Ω—ã –Ω–∞ ReplyKeyboard
- –î–æ–±–∞–≤–ª–µ–Ω—ã —Ñ–ª–∞–≥–∏ `resize_keyboard` –∏ `one_time_keyboard`

### 3. `backend/apps/bot/handlers/basic_handlers.py`
**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –û–±–Ω–æ–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `handle_text_message()` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å ReplyKeyboard
- –î–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç–æ–¥—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–Ω–æ–ø–æ–∫: `_handle_language_button()`, `_handle_currency_button()`, `_handle_menu_button()`
- –£–ø—Ä–æ—â–µ–Ω –º–µ—Ç–æ–¥ `handle_callback_query()` (–∑–∞–≥–ª—É—à–∫–∞)
- –û–±–Ω–æ–≤–ª–µ–Ω—ã –º–µ—Ç–æ–¥—ã –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å ReplyKeyboard

---

## üéØ –†–ï–ó–£–õ–¨–¢–ê–¢–´

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç:
- ‚úÖ **–£–¥–æ–±–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞:** –ö–Ω–æ–ø–∫–∏ –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω—ã –∏ –¥–æ—Å—Ç—É–ø–Ω—ã
- ‚úÖ **–ò–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:** –ü–æ–Ω—è—Ç–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –±–µ–∑ –ø–æ–∏—Å–∫–∞
- ‚úÖ **–ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø:** –ù–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞—Ç—å —á–∞—Ç

### –¢–æ—á–Ω–æ—Å—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:
- ‚úÖ **82.6% —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏** vs ~60% –¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
- ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—è—Ç—ã—Ö** –≤ —á–∏—Å–ª–∞—Ö
- ‚úÖ **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –≤–∞–ª—é—Ç** –≤–æ –≤—Å–µ—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö
- ‚úÖ **–†–∞–±–æ—Ç–∞—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è** –Ω–∞ –≤—Å–µ—Ö —è–∑—ã–∫–∞—Ö

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å:
- ‚úÖ **–£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**
- ‚úÖ **–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- ‚úÖ **Fallback –∞–ª–≥–æ—Ä–∏—Ç–º—ã** –¥–ª—è edge cases
- ‚úÖ **–ü–æ–ª–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º API

---

## üöÄ –ì–û–¢–û–í–ù–û–°–¢–¨ –ö –ü–†–û–î–ê–ö–®–ï–ù–£

–í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é:

1. **–¢–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã:** 82.6% —Ç–æ—á–Ω–æ—Å—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
2. **UI –æ–±–Ω–æ–≤–ª–µ–Ω:** –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ ReplyKeyboard –∑–∞–≤–µ—Ä—à–µ–Ω
3. **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** –ü–æ–ª–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
4. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** ‚úÖ **–ì–û–¢–û–í–û –ö –î–ï–ü–õ–û–Æ** 