# ü§ñ OvozPay Telegram Bot API Documentation

## üöÄ –û–±–∑–æ—Ä

**Telegram Bot:** @OvozPayBot  
**Webhook URL:** `/telegram/webhook/`  
**API Base URL:** `http://localhost:8000/api/`

## üîó –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram

### 1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram
**POST** `/api/auth/telegram-register/`

```json
{
    "telegram_chat_id": "123456789",
    "phone_number": "+998901234567",
    "language": "ru"
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
    "access": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
    "refresh": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
    "user": {
        "id": "550e8400-e29b-41d4-a716-446655440000",
        "phone_number": "+998901234567",
        "language": "ru",
        "is_active": true
    }
}
```

### 2. –õ–æ–≥–∏–Ω —á–µ—Ä–µ–∑ Telegram ID
**POST** `/api/auth/telegram-login/`

```json
{
    "telegram_chat_id": "123456789",
    "phone_number": "+998901234567"  // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
    "access": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
    "refresh": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
    "user": {
        "id": "550e8400-e29b-41d4-a716-446655440000",
        "phone_number": "+998901234567",
        "language": "ru",
        "is_active": true
    }
}
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
**POST** `/api/auth/telegram-auth/`

```json
{
    "telegram_chat_id": "123456789"
}
```

## ü§ñ –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
- `/start` - –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
- `/balance` - –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å
- `/help` - –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º

### –ü—Ä–∏–º–µ—Ä—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è

#### –ö–æ–º–∞–Ω–¥–∞ /start
**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:** `/start`

**–ë–æ—Ç –æ—Ç–≤–µ—Ç:**
```
üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ OvozPay!

–ü—Ä–∏–≤–µ—Ç, –ò–º—è! üëã

–Ø –≤–∞—à –≥–æ–ª–æ—Å–æ–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏. 
–° –º–æ–µ–π –ø–æ–º–æ—â—å—é –≤—ã –º–æ–∂–µ—Ç–µ:

üí∞ –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –¥–æ—Ö–æ–¥—ã –∏ —Ä–∞—Å—Ö–æ–¥—ã
üéØ –£–ø—Ä–∞–≤–ª—è—Ç—å —Ü–µ–ª—è–º–∏ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è  
üìä –ü–æ–ª—É—á–∞—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É –ø–æ —Ç—Ä–∞—Ç–∞–º
üí≥ –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –¥–æ–ª–≥–∏

–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
/balance - –ø–æ–∫–∞–∑–∞—Ç—å –±–∞–ª–∞–Ω—Å
/help - —Å–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º

–î–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å —á–µ—Ä–µ–∑ –Ω–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ!
```

#### –ö–æ–º–∞–Ω–¥–∞ /balance
**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:** `/balance`

**–ë–æ—Ç –æ—Ç–≤–µ—Ç:**
```
üí∞ –í–∞—à –±–∞–ª–∞–Ω—Å

–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: 1,500,000 UZS

üì± –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–¥—Ä–æ–±–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.
```

#### –ö–æ–º–∞–Ω–¥–∞ /help
**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:** `/help`

**–ë–æ—Ç –æ—Ç–≤–µ—Ç:**
```
ü§ñ –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º OvozPay

–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
/start - –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º
/balance - –ø–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å
/help - –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É

–ì–æ–ª–æ—Å–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã:
üé§ –û—Ç–ø—Ä–∞–≤—å—Ç–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è:
‚Ä¢ –î–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞—Ç: "–ü–æ—Ç—Ä–∞—Ç–∏–ª 50000 –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç—ã"
‚Ä¢ –î–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–æ—Ö–æ–¥–æ–≤: "–ü–æ–ª—É—á–∏–ª –∑–∞—Ä–ø–ª–∞—Ç—É 2000000"
‚Ä¢ –°–æ–∑–¥–∞–Ω–∏—è —Ü–µ–ª–µ–π: "–•–æ—á—É –Ω–∞–∫–æ–ø–∏—Ç—å –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω 5000000"

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
üìä –î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
üéØ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ü–µ–ª—è–º–∏ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è
üí≥ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –¥–æ–ª–≥–æ–≤

–î–ª—è –ø–æ–ª–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ—É–Ω–∫—Ü–∏—è–º –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏!
```

## üé§ –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è

–ë–æ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç –≥–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å–∏ –≤ `VoiceCommandLog`.

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ—Ä–∞–∑—ã:**
- **–†–∞—Å—Ö–æ–¥—ã:** "–ø–æ—Ç—Ä–∞—Ç–∏–ª", "–∫—É–ø–∏–ª", "–∑–∞–ø–ª–∞—Ç–∏–ª"
- **–î–æ—Ö–æ–¥—ã:** "–ø–æ–ª—É—á–∏–ª", "–∑–∞—Ä–∞–±–æ—Ç–∞–ª", "–∑–∞—Ä–ø–ª–∞—Ç–∞"
- **–¶–µ–ª–∏:** "–Ω–∞–∫–æ–ø–∏—Ç—å", "—Ü–µ–ª—å", "–∫–æ–ø–∏—Ç—å"

## üì° Webhook

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ webhook
**URL:** `https://your-domain.com/telegram/webhook/`  
**–ú–µ—Ç–æ–¥:** POST  
**Content-Type:** application/json

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ webhook –∑–∞–ø—Ä–æ—Å–∞
```json
{
    "update_id": 123456789,
    "message": {
        "message_id": 123,
        "from": {
            "id": 123456789,
            "is_bot": false,
            "first_name": "–ò–º—è",
            "username": "username"
        },
        "chat": {
            "id": 123456789,
            "first_name": "–ò–º—è",
            "username": "username",
            "type": "private"
        },
        "date": 1640995200,
        "text": "/start"
    }
}
```

### –û—Ç–≤–µ—Ç webhook
```json
200 OK
"OK"
```

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ ngrok
```bash
# macOS
brew install ngrok

# –∏–ª–∏ —Å–∫–∞—á–∞—Ç—å —Å https://ngrok.com/download
```

### 2. –ó–∞–ø—É—Å–∫ ngrok
```bash
ngrok http 8000
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
Forwarding    https://abc123.ngrok.io -> http://localhost:8000
```

### 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ webhook
```bash
curl -X POST \
  "https://api.telegram.org/bot8115661165:AAHWkrF_VVfppRcGjxu5ATlt0uOs5qWLJSw/setWebhook" \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://abc123.ngrok.io/telegram/webhook/"
  }'
```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook
```bash
curl -X GET \
  "https://api.telegram.org/bot8115661165:AAHWkrF_VVfppRcGjxu5ATlt0uOs5qWLJSw/getWebhookInfo"
```

## üõ† API –°–µ—Ä–≤–∏—Å—ã

### TelegramAPIService –º–µ—Ç–æ–¥—ã

#### –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
```python
from apps.bot.telegram.services import TelegramAPIService

service = TelegramAPIService()

# –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
service.send_message(
    chat_id=123456789,
    text="–ü—Ä–∏–≤–µ—Ç! üëã",
    parse_mode="HTML"
)

# –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
await service.send_message_async(
    chat_id=123456789,
    text="–ü—Ä–∏–≤–µ—Ç! üëã",
    parse_mode="HTML"
)
```

#### –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –≥—Ä—É–ø–ø—É
```python
service.send_message_to_group(
    group_chat_id="-100123456789",
    text="–°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –≥—Ä—É–ø–ø—ã"
)
```

#### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ webhook
```python
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ webhook
await service.set_webhook("https://your-domain.com/telegram/webhook/")

# –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ webhook
webhook_info = await service.get_webhook_info()
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏

### BotSession –º–æ–¥–µ–ª—å
–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –±–æ—Ç–µ:
- `telegram_chat_id` - ID —á–∞—Ç–∞ Telegram
- `user` - —Å–≤—è–∑–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
- `is_active` - –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–µ—Å—Å–∏–∏
- `messages_count` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π
- `voice_messages_count` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ–ª–æ—Å–æ–≤—ã—Ö
- `commands_executed` - –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∫–æ–º–∞–Ω–¥

### VoiceCommandLog –º–æ–¥–µ–ª—å
–õ–æ–≥–∏—Ä—É–µ—Ç –≥–æ–ª–æ—Å–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã:
- `user` - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
- `text` - —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
- `status` - —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `original_audio_duration` - –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞—É–¥–∏–æ
- `confidence_score` - —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### JWT —Ç–æ–∫–µ–Ω—ã
- **Access Token:** 60 –º–∏–Ω—É—Ç
- **Refresh Token:** 7 –¥–Ω–µ–π  
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–æ—Ç–∞—Ü–∏—è** refresh —Ç–æ–∫–µ–Ω–æ–≤
- **Blacklist** –ø–æ—Å–ª–µ —Ä–æ—Ç–∞—Ü–∏–∏

### –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
```http
Authorization: Bearer <access_token>
```

### –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤ —Å —Ç–æ–∫–µ–Ω–∞–º–∏
```bash
# –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
curl -X GET \
  "http://localhost:8000/api/users/api/users/" \
  -H "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."

# –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
curl -X POST \
  "http://localhost:8000/api/transactions/api/transactions/" \
  -H "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..." \
  -H "Content-Type: application/json" \
  -d '{
    "amount": "1000.00",
    "type": "expense",
    "description": "–ü–æ–∫—É–ø–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤",
    "date": "2024-01-01T12:00:00Z"
  }'
```

## üö® –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ –∏ —Ä–µ—à–µ–Ω–∏—è

#### 1. Webhook –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ webhook
curl https://your-domain.com/telegram/webhook/
```

#### 2. –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –Ω–µ–≤–µ—Ä–Ω—ã–π
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–æ—Ç–∞
curl "https://api.telegram.org/bot8115661165:AAHWkrF_VVfppRcGjxu5ATlt0uOs5qWLJSw/getMe"
```

#### 3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª `/start`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ `BotSession` –¥–ª—è `telegram_chat_id`

#### 4. JWT —Ç–æ–∫–µ–Ω –∏—Å—Ç–µ–∫
```json
{
    "detail": "Given token not valid for any token type",
    "code": "token_not_valid",
    "messages": [
        {
            "token_class": "AccessToken",
            "token_type": "access",
            "message": "Token is invalid or expired"
        }
    ]
}
```

**–†–µ—à–µ–Ω–∏–µ:** –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ refresh token

## üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
**POST** `/api/token/refresh/`

```json
{
    "refresh": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
    "access": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
}
``` 